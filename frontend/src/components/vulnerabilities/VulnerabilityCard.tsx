/**
 * Vulnerability Card Component
 * Displays individual vulnerability with severity, details, and actions
 */

import {
  Card,
  CardContent,
  Typography,
  Box,
  Chip,
  Button,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Divider,
  Link,
} from '@mui/material';
import ExpandMoreIcon from '@mui/icons-material/ExpandMore';
import BugReportIcon from '@mui/icons-material/BugReport';
import CodeIcon from '@mui/icons-material/Code';
import SecurityIcon from '@mui/icons-material/Security';
import LinkIcon from '@mui/icons-material/Link';
import type { Vulnerability } from '../../types';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  onViewDetails?: (vuln: Vulnerability) => void;
}

const VulnerabilityCard = ({ vulnerability, onViewDetails }: VulnerabilityCardProps) => {
  const getSeverityColor = (severity: string) => {
    switch (severity.toLowerCase()) {
      case 'critical':
        return '#b71c1c';
      case 'high':
        return '#ff5252';
      case 'medium':
        return '#ff9800';
      case 'low':
        return '#00bcd4';
      case 'info':
        return '#757575';
      default:
        return '#757575';
    }
  };

  const getCVSSColor = (score: number) => {
    if (score >= 9.0) return '#b71c1c';
    if (score >= 7.0) return '#ff5252';
    if (score >= 4.0) return '#ff9800';
    if (score >= 0.1) return '#00bcd4';
    return '#757575';
  };

  return (
    <Card
      sx={{
        borderLeft: '4px solid',
        borderColor: getSeverityColor(vulnerability.severity),
        transition: 'all 0.3s',
        '&:hover': {
          boxShadow: `0 8px 24px ${getSeverityColor(vulnerability.severity)}30`,
        },
      }}
    >
      <CardContent>
        {/* Header */}
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 2 }}>
          <Box sx={{ flex: 1 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
              <BugReportIcon sx={{ color: getSeverityColor(vulnerability.severity) }} />
              <Typography variant="h6" sx={{ fontWeight: 700 }}>
                {vulnerability.title}
              </Typography>
            </Box>
            <Typography variant="body2" color="text.secondary">
              {vulnerability.description}
            </Typography>
          </Box>
          <Chip
            label={vulnerability.severity.toUpperCase()}
            sx={{
              bgcolor: getSeverityColor(vulnerability.severity),
              color: 'white',
              fontWeight: 700,
              ml: 2,
            }}
          />
        </Box>

        {/* Metadata */}
        <Box sx={{ display: 'flex', gap: 2, mb: 2, flexWrap: 'wrap' }}>
          {vulnerability.cvssScore && (
            <Chip
              label={`CVSS: ${vulnerability.cvssScore}`}
              size="small"
              sx={{
                bgcolor: getCVSSColor(vulnerability.cvssScore),
                color: 'white',
                fontWeight: 600,
              }}
            />
          )}
          {vulnerability.cveId && (
            <Chip
              label={vulnerability.cveId}
              size="small"
              variant="outlined"
              icon={<SecurityIcon />}
            />
          )}
          {vulnerability.cweId && (
            <Chip
              label={vulnerability.cweId}
              size="small"
              variant="outlined"
            />
          )}
          <Chip
            label={`Discovered by ${vulnerability.discoveredBy}`}
            size="small"
            variant="outlined"
          />
        </Box>

        {/* Location */}
        <Box sx={{ mb: 2 }}>
          <Typography variant="caption" color="text.secondary">
            Location:
          </Typography>
          <Typography
            variant="body2"
            sx={{
              fontFamily: "'JetBrains Mono', monospace",
              bgcolor: 'action.hover',
              p: 1,
              borderRadius: 1,
              mt: 0.5,
            }}
          >
            {vulnerability.location}
          </Typography>
        </Box>

        <Divider sx={{ my: 2 }} />

        {/* Proof of Concept */}
        {vulnerability.proofOfConcept && (
          <Accordion
            elevation={0}
            sx={{
              bgcolor: 'transparent',
              '&:before': { display: 'none' },
            }}
          >
            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <CodeIcon fontSize="small" />
                <Typography variant="body2" fontWeight={600}>
                  Proof of Concept
                </Typography>
              </Box>
            </AccordionSummary>
            <AccordionDetails>
              <Box
                sx={{
                  fontFamily: "'JetBrains Mono', monospace",
                  fontSize: '0.875rem',
                  bgcolor: 'background.paper',
                  p: 2,
                  borderRadius: 1,
                  border: '1px solid',
                  borderColor: 'divider',
                  overflowX: 'auto',
                }}
              >
                <pre style={{ margin: 0, whiteSpace: 'pre-wrap' }}>
                  {vulnerability.proofOfConcept}
                </pre>
              </Box>
            </AccordionDetails>
          </Accordion>
        )}

        {/* Remediation */}
        {vulnerability.remediation && (
          <Accordion
            elevation={0}
            sx={{
              bgcolor: 'transparent',
              '&:before': { display: 'none' },
            }}
          >
            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <SecurityIcon fontSize="small" />
                <Typography variant="body2" fontWeight={600}>
                  Remediation
                </Typography>
              </Box>
            </AccordionSummary>
            <AccordionDetails>
              <Typography variant="body2" color="text.secondary">
                {vulnerability.remediation}
              </Typography>
            </AccordionDetails>
          </Accordion>
        )}

        {/* References */}
        {vulnerability.references && vulnerability.references.length > 0 && (
          <Accordion
            elevation={0}
            sx={{
              bgcolor: 'transparent',
              '&:before': { display: 'none' },
            }}
          >
            <AccordionSummary expandIcon={<ExpandMoreIcon />}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <LinkIcon fontSize="small" />
                <Typography variant="body2" fontWeight={600}>
                  References ({vulnerability.references.length})
                </Typography>
              </Box>
            </AccordionSummary>
            <AccordionDetails>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                {vulnerability.references.map((ref, index) => (
                  <Link
                    key={index}
                    href={ref}
                    target="_blank"
                    rel="noopener noreferrer"
                    sx={{ fontSize: '0.875rem' }}
                  >
                    {ref}
                  </Link>
                ))}
              </Box>
            </AccordionDetails>
          </Accordion>
        )}

        {/* Actions */}
        <Box sx={{ display: 'flex', gap: 1, mt: 2 }}>
          {onViewDetails && (
            <Button
              variant="contained"
              size="small"
              onClick={() => onViewDetails(vulnerability)}
            >
              View Details
            </Button>
          )}
          <Button variant="outlined" size="small">
            Export
          </Button>
          {vulnerability.proofOfConcept && (
            <Button variant="outlined" size="small">
              Copy PoC
            </Button>
          )}
        </Box>
      </CardContent>
    </Card>
  );
};

export default VulnerabilityCard;
