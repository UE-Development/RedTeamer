/**
 * Vulnerability Detail Dialog Component
 * Full-featured dialog for viewing and managing vulnerability details
 */

import { useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Box,
  Typography,
  Button,
  Chip,
  Tabs,
  Tab,
  Divider,
  Grid,
  Paper,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Link,
  IconButton,
  TextField,
  FormControl,
  Select,
  MenuItem,
  Snackbar,
  Alert,
} from '@mui/material';
import {
  Timeline,
  TimelineItem,
  TimelineSeparator,
  TimelineConnector,
  TimelineContent,
  TimelineDot,
} from '@mui/lab';
import CloseIcon from '@mui/icons-material/Close';
import BugReportIcon from '@mui/icons-material/BugReport';
import CodeIcon from '@mui/icons-material/Code';
import SecurityIcon from '@mui/icons-material/Security';
import LinkIcon from '@mui/icons-material/Link';
import DownloadIcon from '@mui/icons-material/Download';
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import EditIcon from '@mui/icons-material/Edit';
import SaveIcon from '@mui/icons-material/Save';
import HistoryIcon from '@mui/icons-material/History';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import WarningIcon from '@mui/icons-material/Warning';
import ErrorIcon from '@mui/icons-material/Error';
import type { Vulnerability, VulnerabilityStatus } from '../../types';
import CVSSCalculator from './CVSSCalculator';

interface VulnerabilityDetailDialogProps {
  open: boolean;
  onClose: () => void;
  vulnerability: Vulnerability | null;
  onStatusChange?: (id: string, status: VulnerabilityStatus) => void;
  onExport?: (vulnerability: Vulnerability, format: 'json' | 'pdf' | 'csv') => void;
}

interface TimelineEvent {
  id: string;
  date: string;
  action: string;
  user: string;
  details?: string;
}

const VulnerabilityDetailDialog = ({
  open,
  onClose,
  vulnerability,
  onStatusChange,
  onExport,
}: VulnerabilityDetailDialogProps) => {
  const [activeTab, setActiveTab] = useState(0);
  const [isEditing, setIsEditing] = useState(false);
  const [editedStatus, setEditedStatus] = useState<VulnerabilityStatus>('new');
  const [notes, setNotes] = useState('');
  const [snackbar, setSnackbar] = useState<{ open: boolean; message: string; severity: 'success' | 'error' }>({
    open: false,
    message: '',
    severity: 'success',
  });

  // Mock timeline data - use static dates to avoid impure function calls during render
  const getTimelineData = (): TimelineEvent[] => {
    if (!vulnerability) return [];
    const baseDate = new Date(vulnerability.discoveredAt);
    return [
      {
        id: '1',
        date: vulnerability.discoveredAt,
        action: 'Discovered',
        user: vulnerability.discoveredBy || 'System',
        details: 'Vulnerability initially discovered during automated scan',
      },
      {
        id: '2',
        date: new Date(baseDate.getTime() + 2 * 60 * 60 * 1000).toISOString(),
        action: 'Confirmed',
        user: 'Security Analyst',
        details: 'Vulnerability confirmed through manual verification',
      },
      {
        id: '3',
        date: new Date(baseDate.getTime() + 3 * 60 * 60 * 1000).toISOString(),
        action: 'Assigned',
        user: 'Project Manager',
        details: 'Assigned to development team for remediation',
      },
    ];
  };

  if (!vulnerability) return null;

  const timeline = getTimelineData();

  const getSeverityColor = (severity: string) => {
    switch (severity.toLowerCase()) {
      case 'critical': return '#b71c1c';
      case 'high': return '#ff5252';
      case 'medium': return '#ff9800';
      case 'low': return '#00bcd4';
      default: return '#757575';
    }
  };

  const getStatusIcon = (status: VulnerabilityStatus) => {
    switch (status) {
      case 'new': return <WarningIcon color="warning" />;
      case 'confirmed': return <ErrorIcon color="error" />;
      case 'false_positive': return <CheckCircleIcon color="info" />;
      case 'remediated': return <CheckCircleIcon color="success" />;
      default: return <BugReportIcon />;
    }
  };

  const handleCopyPoC = () => {
    if (vulnerability.proofOfConcept) {
      navigator.clipboard.writeText(vulnerability.proofOfConcept);
      setSnackbar({ open: true, message: 'PoC copied to clipboard!', severity: 'success' });
    }
  };

  const handleSaveChanges = () => {
    if (onStatusChange && editedStatus !== vulnerability.status) {
      onStatusChange(vulnerability.id, editedStatus);
    }
    setIsEditing(false);
    setSnackbar({ open: true, message: 'Changes saved successfully!', severity: 'success' });
  };

  const handleExport = (format: 'json' | 'pdf' | 'csv') => {
    if (onExport) {
      onExport(vulnerability, format);
    } else {
      // Default export behavior
      if (format === 'json') {
        const blob = new Blob([JSON.stringify(vulnerability, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vulnerability-${vulnerability.id}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      setSnackbar({ open: true, message: `Exported as ${format.toUpperCase()}`, severity: 'success' });
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString();
  };

  return (
    <>
      <Dialog
        open={open}
        onClose={onClose}
        maxWidth="lg"
        fullWidth
        PaperProps={{
          sx: {
            minHeight: '80vh',
            borderTop: '4px solid',
            borderColor: getSeverityColor(vulnerability.severity),
          },
        }}
      >
        <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
          <BugReportIcon sx={{ color: getSeverityColor(vulnerability.severity) }} />
          <Box sx={{ flex: 1 }}>
            <Typography variant="h6" sx={{ fontWeight: 700 }}>
              {vulnerability.title}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              {vulnerability.cveId && `${vulnerability.cveId} • `}
              {vulnerability.cweId && `${vulnerability.cweId} • `}
              Discovered {formatDate(vulnerability.discoveredAt)}
            </Typography>
          </Box>
          <Chip
            label={vulnerability.severity.toUpperCase()}
            sx={{
              bgcolor: getSeverityColor(vulnerability.severity),
              color: 'white',
              fontWeight: 700,
            }}
          />
          <IconButton onClick={onClose}>
            <CloseIcon />
          </IconButton>
        </DialogTitle>

        <Tabs
          value={activeTab}
          onChange={(_, newValue) => setActiveTab(newValue)}
          sx={{ borderBottom: 1, borderColor: 'divider', px: 3 }}
        >
          <Tab label="Details" />
          <Tab label="Proof of Concept" />
          <Tab label="Remediation" />
          <Tab label="CVSS Calculator" />
          <Tab label="Timeline" />
        </Tabs>

        <DialogContent sx={{ p: 0 }}>
          {/* Details Tab */}
          {activeTab === 0 && (
            <Box sx={{ p: 3 }}>
              <Grid container spacing={3}>
                <Grid size={{ xs: 12, md: 8 }}>
                  {/* Description */}
                  <Paper sx={{ p: 2, mb: 2 }}>
                    <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600 }}>
                      Description
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      {vulnerability.description}
                    </Typography>
                  </Paper>

                  {/* Location */}
                  <Paper sx={{ p: 2, mb: 2 }}>
                    <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600 }}>
                      Affected Location
                    </Typography>
                    <Box
                      sx={{
                        fontFamily: "'JetBrains Mono', monospace",
                        bgcolor: 'action.hover',
                        p: 1.5,
                        borderRadius: 1,
                        wordBreak: 'break-all',
                      }}
                    >
                      {vulnerability.location}
                    </Box>
                  </Paper>

                  {/* References */}
                  {vulnerability.references && vulnerability.references.length > 0 && (
                    <Paper sx={{ p: 2 }}>
                      <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600 }}>
                        References
                      </Typography>
                      <List dense>
                        {vulnerability.references.map((ref, idx) => (
                          <ListItem key={idx}>
                            <ListItemIcon sx={{ minWidth: 32 }}>
                              <LinkIcon fontSize="small" />
                            </ListItemIcon>
                            <ListItemText
                              primary={
                                <Link href={ref} target="_blank" rel="noopener noreferrer">
                                  {ref}
                                </Link>
                              }
                            />
                          </ListItem>
                        ))}
                      </List>
                    </Paper>
                  )}
                </Grid>

                <Grid size={{ xs: 12, md: 4 }}>
                  {/* Metadata Card */}
                  <Paper sx={{ p: 2, mb: 2 }}>
                    <Typography variant="subtitle1" sx={{ mb: 2, fontWeight: 600 }}>
                      Vulnerability Info
                    </Typography>
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                      <Box>
                        <Typography variant="caption" color="text.secondary">
                          CVSS Score
                        </Typography>
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                          <Typography variant="h4" sx={{ fontWeight: 700, color: getSeverityColor(vulnerability.severity) }}>
                            {vulnerability.cvssScore}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            / 10
                          </Typography>
                        </Box>
                      </Box>
                      
                      <Divider />
                      
                      <Box>
                        <Typography variant="caption" color="text.secondary">
                          Status
                        </Typography>
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 0.5 }}>
                          {isEditing ? (
                            <FormControl size="small" fullWidth>
                              <Select
                                value={editedStatus}
                                onChange={(e) => setEditedStatus(e.target.value as VulnerabilityStatus)}
                              >
                                <MenuItem value="new">New</MenuItem>
                                <MenuItem value="confirmed">Confirmed</MenuItem>
                                <MenuItem value="false_positive">False Positive</MenuItem>
                                <MenuItem value="remediated">Remediated</MenuItem>
                              </Select>
                            </FormControl>
                          ) : (
                            <>
                              {getStatusIcon(vulnerability.status)}
                              <Typography variant="body1" sx={{ textTransform: 'capitalize' }}>
                                {vulnerability.status.replace('_', ' ')}
                              </Typography>
                            </>
                          )}
                        </Box>
                      </Box>

                      <Divider />

                      <Box>
                        <Typography variant="caption" color="text.secondary">
                          Discovered By
                        </Typography>
                        <Typography variant="body1">{vulnerability.discoveredBy}</Typography>
                      </Box>

                      {vulnerability.cveId && (
                        <>
                          <Divider />
                          <Box>
                            <Typography variant="caption" color="text.secondary">
                              CVE ID
                            </Typography>
                            <Chip
                              label={vulnerability.cveId}
                              size="small"
                              icon={<SecurityIcon />}
                              sx={{ mt: 0.5 }}
                            />
                          </Box>
                        </>
                      )}

                      {vulnerability.cweId && (
                        <>
                          <Divider />
                          <Box>
                            <Typography variant="caption" color="text.secondary">
                              CWE ID
                            </Typography>
                            <Chip label={vulnerability.cweId} size="small" sx={{ mt: 0.5 }} />
                          </Box>
                        </>
                      )}
                    </Box>
                  </Paper>

                  {/* Notes */}
                  <Paper sx={{ p: 2 }}>
                    <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600 }}>
                      Notes
                    </Typography>
                    <TextField
                      multiline
                      rows={4}
                      fullWidth
                      placeholder="Add notes about this vulnerability..."
                      value={notes}
                      onChange={(e) => setNotes(e.target.value)}
                      size="small"
                    />
                  </Paper>
                </Grid>
              </Grid>
            </Box>
          )}

          {/* PoC Tab */}
          {activeTab === 1 && (
            <Box sx={{ p: 3 }}>
              {vulnerability.proofOfConcept ? (
                <Paper sx={{ p: 2 }}>
                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
                    <CodeIcon color="primary" />
                    <Typography variant="subtitle1" sx={{ fontWeight: 600, flex: 1 }}>
                      Proof of Concept
                    </Typography>
                    <Button
                      size="small"
                      startIcon={<ContentCopyIcon />}
                      onClick={handleCopyPoC}
                    >
                      Copy
                    </Button>
                  </Box>
                  <Box
                    sx={{
                      fontFamily: "'JetBrains Mono', monospace",
                      fontSize: '0.875rem',
                      bgcolor: '#1a1a2e',
                      color: '#00ff41',
                      p: 2,
                      borderRadius: 1,
                      overflowX: 'auto',
                    }}
                  >
                    <pre style={{ margin: 0, whiteSpace: 'pre-wrap' }}>
                      {vulnerability.proofOfConcept}
                    </pre>
                  </Box>
                </Paper>
              ) : (
                <Paper sx={{ p: 4, textAlign: 'center' }}>
                  <CodeIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="h6" color="text.secondary">
                    No Proof of Concept Available
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    A PoC has not been generated for this vulnerability yet.
                  </Typography>
                </Paper>
              )}
            </Box>
          )}

          {/* Remediation Tab */}
          {activeTab === 2 && (
            <Box sx={{ p: 3 }}>
              <Paper sx={{ p: 2 }}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
                  <SecurityIcon color="success" />
                  <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
                    Remediation Guidance
                  </Typography>
                </Box>
                {vulnerability.remediation ? (
                  <Typography variant="body2" sx={{ whiteSpace: 'pre-wrap' }}>
                    {vulnerability.remediation}
                  </Typography>
                ) : (
                  <Typography variant="body2" color="text.secondary">
                    No remediation guidance available. Consider consulting security resources for {vulnerability.cweId || 'this vulnerability type'}.
                  </Typography>
                )}

                {/* General recommendations based on vulnerability type */}
                <Divider sx={{ my: 3 }} />
                <Typography variant="subtitle2" sx={{ mb: 2, fontWeight: 600 }}>
                  General Recommendations
                </Typography>
                <List dense>
                  <ListItem>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary="Validate and sanitize all user inputs" />
                  </ListItem>
                  <ListItem>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary="Implement proper access controls and authentication" />
                  </ListItem>
                  <ListItem>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary="Keep all software and dependencies up to date" />
                  </ListItem>
                  <ListItem>
                    <ListItemIcon>
                      <CheckCircleIcon color="success" fontSize="small" />
                    </ListItemIcon>
                    <ListItemText primary="Conduct regular security testing and code reviews" />
                  </ListItem>
                </List>
              </Paper>
            </Box>
          )}

          {/* CVSS Calculator Tab */}
          {activeTab === 3 && (
            <Box sx={{ p: 3 }}>
              <CVSSCalculator
                onCalculate={(result) => {
                  console.log('CVSS calculated:', result);
                }}
              />
            </Box>
          )}

          {/* Timeline Tab */}
          {activeTab === 4 && (
            <Box sx={{ p: 3 }}>
              <Paper sx={{ p: 2 }}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
                  <HistoryIcon color="primary" />
                  <Typography variant="subtitle1" sx={{ fontWeight: 600 }}>
                    Vulnerability Timeline
                  </Typography>
                </Box>
                <Timeline position="right" sx={{ p: 0 }}>
                  {timeline.map((event, index) => (
                    <TimelineItem key={event.id}>
                      <TimelineSeparator>
                        <TimelineDot color={index === 0 ? 'primary' : 'grey'} />
                        {index < timeline.length - 1 && <TimelineConnector />}
                      </TimelineSeparator>
                      <TimelineContent>
                        <Paper sx={{ p: 2 }}>
                          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <Typography variant="subtitle2" fontWeight={600}>
                              {event.action}
                            </Typography>
                            <Typography variant="caption" color="text.secondary">
                              {formatDate(event.date)}
                            </Typography>
                          </Box>
                          <Typography variant="body2" color="text.secondary">
                            by {event.user}
                          </Typography>
                          {event.details && (
                            <Typography variant="body2" sx={{ mt: 1 }}>
                              {event.details}
                            </Typography>
                          )}
                        </Paper>
                      </TimelineContent>
                    </TimelineItem>
                  ))}
                </Timeline>
              </Paper>
            </Box>
          )}
        </DialogContent>

        <Divider />

        <DialogActions sx={{ p: 2, gap: 1 }}>
          <Box sx={{ flex: 1, display: 'flex', gap: 1 }}>
            <Button
              size="small"
              startIcon={<DownloadIcon />}
              onClick={() => handleExport('json')}
            >
              Export JSON
            </Button>
            <Button
              size="small"
              startIcon={<DownloadIcon />}
              onClick={() => handleExport('pdf')}
            >
              Export PDF
            </Button>
            <Button
              size="small"
              startIcon={<DownloadIcon />}
              onClick={() => handleExport('csv')}
            >
              Export CSV
            </Button>
          </Box>
          {isEditing ? (
            <>
              <Button onClick={() => setIsEditing(false)}>Cancel</Button>
              <Button
                variant="contained"
                startIcon={<SaveIcon />}
                onClick={handleSaveChanges}
              >
                Save Changes
              </Button>
            </>
          ) : (
            <Button
              variant="outlined"
              startIcon={<EditIcon />}
              onClick={() => {
                setIsEditing(true);
                setEditedStatus(vulnerability.status);
              }}
            >
              Edit Status
            </Button>
          )}
          <Button variant="contained" onClick={onClose}>
            Close
          </Button>
        </DialogActions>
      </Dialog>

      <Snackbar
        open={snackbar.open}
        autoHideDuration={3000}
        onClose={() => setSnackbar({ ...snackbar, open: false })}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
      >
        <Alert severity={snackbar.severity} onClose={() => setSnackbar({ ...snackbar, open: false })}>
          {snackbar.message}
        </Alert>
      </Snackbar>
    </>
  );
};

export default VulnerabilityDetailDialog;
