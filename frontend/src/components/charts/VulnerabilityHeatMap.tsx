/**
 * Vulnerability Heat Map
 * Displays vulnerability density across different categories
 */

import { Box, Typography, Paper, Tooltip, useTheme } from '@mui/material';

interface HeatMapCell {
  category: string;
  severity: string;
  count: number;
}

interface VulnerabilityHeatMapProps {
  data?: HeatMapCell[];
  title?: string;
}

const categories = ['Web', 'Network', 'API', 'Cloud', 'Mobile', 'Binary'];
const severities = ['Critical', 'High', 'Medium', 'Low', 'Info'];

// Default mock data for demonstration
const generateDefaultData = (): HeatMapCell[] => {
  const data: HeatMapCell[] = [];
  const counts: Record<string, Record<string, number>> = {
    Web: { Critical: 3, High: 8, Medium: 15, Low: 12, Info: 5 },
    Network: { Critical: 2, High: 5, Medium: 10, Low: 8, Info: 3 },
    API: { Critical: 4, High: 12, Medium: 20, Low: 15, Info: 8 },
    Cloud: { Critical: 1, High: 3, Medium: 6, Low: 4, Info: 2 },
    Mobile: { Critical: 1, High: 2, Medium: 5, Low: 3, Info: 1 },
    Binary: { Critical: 2, High: 4, Medium: 8, Low: 6, Info: 2 },
  };

  categories.forEach((category) => {
    severities.forEach((severity) => {
      data.push({
        category,
        severity,
        count: counts[category]?.[severity] || 0,
      });
    });
  });

  return data;
};

const defaultData = generateDefaultData();

const getHeatColor = (count: number, severity: string): string => {
  const baseColors: Record<string, string[]> = {
    Critical: ['#2d0000', '#4a0000', '#6e0000', '#b71c1c', '#d32f2f'],
    High: ['#3d0000', '#5a0000', '#7e0000', '#ff5252', '#ff7373'],
    Medium: ['#3d2600', '#5a3900', '#7e5000', '#ff9800', '#ffb74d'],
    Low: ['#3d3d00', '#5a5a00', '#7e7e00', '#ffeb3b', '#fff176'],
    Info: ['#002a3d', '#003d5a', '#00577e', '#00bcd4', '#4dd0e1'],
  };

  const colors = baseColors[severity] || baseColors.Info;
  if (count === 0) return 'transparent';
  if (count <= 2) return colors[1];
  if (count <= 5) return colors[2];
  if (count <= 10) return colors[3];
  return colors[4];
};

const VulnerabilityHeatMap = ({
  data = defaultData,
  title = 'Vulnerability Heat Map',
}: VulnerabilityHeatMapProps) => {
  const theme = useTheme();

  const getCount = (category: string, severity: string): number => {
    return data.find((d) => d.category === category && d.severity === severity)?.count || 0;
  };

  return (
    <Paper sx={{ p: 2 }}>
      <Typography variant="h6" sx={{ mb: 2, fontWeight: 600 }}>
        ðŸ”¥ {title}
      </Typography>

      {/* Header Row */}
      <Box sx={{ display: 'flex', mb: 1 }}>
        <Box sx={{ width: 80 }} />
        {severities.map((severity) => (
          <Box
            key={severity}
            sx={{
              flex: 1,
              textAlign: 'center',
              px: 1,
            }}
          >
            <Typography
              variant="caption"
              sx={{
                fontWeight: 600,
                color:
                  severity === 'Critical'
                    ? '#b71c1c'
                    : severity === 'High'
                      ? '#ff5252'
                      : severity === 'Medium'
                        ? '#ff9800'
                        : severity === 'Low'
                          ? '#ffeb3b'
                          : '#00bcd4',
              }}
            >
              {severity}
            </Typography>
          </Box>
        ))}
      </Box>

      {/* Heat Map Grid */}
      {categories.map((category) => (
        <Box key={category} sx={{ display: 'flex', mb: 0.5 }}>
          <Box
            sx={{
              width: 80,
              display: 'flex',
              alignItems: 'center',
            }}
          >
            <Typography variant="caption" color="text.secondary">
              {category}
            </Typography>
          </Box>
          {severities.map((severity) => {
            const count = getCount(category, severity);
            return (
              <Tooltip
                key={`${category}-${severity}`}
                title={`${category} - ${severity}: ${count} vulnerabilities`}
                arrow
              >
                <Box
                  sx={{
                    flex: 1,
                    height: 40,
                    mx: 0.25,
                    borderRadius: 1,
                    bgcolor: getHeatColor(count, severity),
                    border: `1px solid ${theme.palette.divider}`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    cursor: 'pointer',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                    '&:hover': {
                      transform: 'scale(1.05)',
                      boxShadow: `0 4px 12px ${theme.palette.primary.main}40`,
                      zIndex: 1,
                    },
                  }}
                >
                  {count > 0 && (
                    <Typography
                      variant="caption"
                      sx={{
                        fontWeight: 600,
                        color: count > 5 ? '#fff' : theme.palette.text.primary,
                        fontFamily: "'JetBrains Mono', monospace",
                      }}
                    >
                      {count}
                    </Typography>
                  )}
                </Box>
              </Tooltip>
            );
          })}
        </Box>
      ))}

      {/* Legend */}
      <Box
        sx={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          mt: 2,
          gap: 1,
        }}
      >
        <Typography variant="caption" color="text.secondary">
          Less
        </Typography>
        {[0, 2, 5, 10, 15].map((value, index) => (
          <Box
            key={index}
            sx={{
              width: 16,
              height: 16,
              borderRadius: 0.5,
              bgcolor: getHeatColor(value, 'High'),
              border: `1px solid ${theme.palette.divider}`,
            }}
          />
        ))}
        <Typography variant="caption" color="text.secondary">
          More
        </Typography>
      </Box>
    </Paper>
  );
};

export default VulnerabilityHeatMap;
